<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NICU Booking/Viewing Page</title>
  <link rel="stylesheet" href="styles/mainStyle.css" />
</head>
<body>
  <div class="top-section">
    <!-- LEFT side: patient list -->
    <div class="left">
      <h2>Current NICU Patients</h2>
      <ul id="appointmentList">
        <li class="appointment-item" data-room="N401">
          <span class="appointment-info">Room N401 - Jane Doe - MRN: 123456</span>
          <div class="view-container">
            <button class="view-button" onclick="toggleVideoBox('N401')">View Meeting</button>
            <button class="remove-button" onclick="removePatient(this)">Remove</button>
            <div class="video-box" id="video-N401" style="display: none;">
              <p>Video session details for Room N401.</p>
            </div>
          </div>
        </li>
        <li class="appointment-item" data-room="N402">
          <span class="appointment-info">Room N402 - John Smith - MRN: 654321</span>
          <div class="view-container">
            <button class="view-button" onclick="toggleVideoBox('N402')">View Meeting</button>
            <button class="remove-button" onclick="removePatient(this)">Remove</button>
            <div class="video-box" id="video-N402" style="display: none;">
              <p>Video session details for Room N402.</p>
            </div>
          </div>
        </li>
        <li class="appointment-item" data-room="N403">
          <span class="appointment-info">Room N403 - Alice Johnson - MRN: 112233</span>
          <div class="view-container">
            <button class="view-button" onclick="toggleVideoBox('N403')">View Meeting</button>
            <button class="remove-button" onclick="removePatient(this)">Remove</button>
            <div class="video-box" id="video-N403" style="display: none;">
              <p>Video session details for Room N403.</p>
            </div>
          </div>
        </li>
        <li class="appointment-item" data-room="N404">
          <span class="appointment-info">Room N404 - Bob Brown - MRN: 445566</span>
          <div class="view-container">
            <button class="view-button" onclick="toggleVideoBox('N404')">View Meeting</button>
            <button class="remove-button" onclick="removePatient(this)">Remove</button>
            <div class="video-box" id="video-N404" style="display: none;">
              <p>Video session details for Room N404.</p>
            </div>
          </div>
        </li>
        <li class="appointment-item" data-room="N405">
          <span class="appointment-info">Room N405 - Carol White - MRN: 778899</span>
          <div class="view-container">
            <button class="view-button" onclick="toggleVideoBox('N405')">View Meeting</button>
            <button class="remove-button" onclick="removePatient(this)">Remove</button>
            <div class="video-box" id="video-N405" style="display: none;">
              <p>Video session details for Room N405.</p>
            </div>
          </div>
        </li>
      </ul>
    </div>

 <!-- RIGHT side: new patient form -->
    <div class="right">
      <h2>Add New NICU Patient</h2>
      <form id="appointmentForm">
        <label for="room">Room Number</label>
        <select id="room" required></select>
        <input type="text" placeholder="Patient Name" id="patientName" required />
        <input type="text" placeholder="MRN (Auto-generated)" id="mrn" readonly />
        <input type="text" placeholder="Parent 1 Name" id="parent1Name" required />
        <input type="text" placeholder="Parent 1 Phone" id="parent1Phone" required />
        <input type="text" placeholder="Parent 2 Name (Optional)" id="parent2Name" />
        <input type="text" placeholder="Parent 2 Phone (Optional)" id="parent2Phone" />
        <button type="submit">Add Patient</button>
      </form>
    </div>
  </div>

  <!-- Below patients list: video container -->
  <div id="videoContainer">
    <h3>Live Call</h3>
    <div id="noObservation" style="display: block; padding: 15px; background: #f0f0f0; border: 1px solid #ccc; border-radius: 8px;">
      <p><strong>Nothing is currently being observed.</strong><br />Click "View Meeting" to observe a current patient.</p>
    </div>
    <div class="video-wrapper" style="display: none;">
      <video id="remoteVideo" autoplay playsinline></video>
      <video id="localVideo" autoplay muted playsinline></video>
    </div>
    <div class="controls" style="display: none;">
      <button id="btnVideo" class="control-btn btn-video on" title="Toggle Video"></button>
      <button id="btnMic" class="control-btn btn-mic on" title="Toggle Microphone"></button>
      <button id="btnSpeaker" class="control-btn btn-speaker on" title="Toggle Speaker"></button>
      <button id="endBtn" class="control-btn btn-end" title="End Call"></button>
    </div>
  </div>

  <script>
    const form = document.getElementById('appointmentForm');
    const appointmentList = document.getElementById('appointmentList');
    const roomSelect = document.getElementById('room');
    const mrnField = document.getElementById('mrn');

    window.addEventListener('load', () => {
      mrnField.value = generateMRN();
    });

    const usedRooms = [...appointmentList.querySelectorAll('li')].map(li => li.getAttribute('data-room'));
    for (let i = 401; i <= 430; i++) {
      const roomLabel = `N${i}`;
      if (!usedRooms.includes(roomLabel)) {
        const opt = document.createElement('option');
        opt.value = roomLabel;
        opt.textContent = roomLabel;
        roomSelect.appendChild(opt);
      }
    }

    function generateMRN() {
      return Math.floor(100000 + Math.random() * 900000).toString();
    }

    form.addEventListener('submit', function(e) {
      e.preventDefault();
      const room = roomSelect.value;
      const patient = document.getElementById('patientName').value;
      const mrn = mrnField.value;

      const newItem = document.createElement('li');
      newItem.className = 'appointment-item';
      newItem.setAttribute('data-room', room);
      newItem.innerHTML = `
        <span class="appointment-info">Room ${room} - ${patient} - MRN: ${mrn}</span>
        <div class="view-container">
          <button class="view-button" onclick="toggleVideoBox('${room}')">View Meeting</button>
          <div class="video-box" id="video-${room}" style="display: none;">
            <p>Video session details for Room ${room}.</p>
          </div>
        </div>
      `;

      const items = [...appointmentList.querySelectorAll('li')];
      items.push(newItem);
      items.sort((a, b) => parseInt(a.dataset.room.replace(/\D/g, '')) - parseInt(b.dataset.room.replace(/\D/g, '')));
      appointmentList.innerHTML = '';
      items.forEach(item => appointmentList.appendChild(item));

      roomSelect.querySelector(`option[value="${room}"]`).remove();
      form.reset();
      mrnField.value = generateMRN();
    });

    function toggleVideoBox(roomId) {
      const box = document.getElementById(`video-${roomId}`);
      box.style.display = box.style.display === 'none' ? 'block' : 'none';

      // When a meeting is viewed, hide the noObservation box and show the video elements
      document.getElementById('noObservation').style.display = 'none';
      document.querySelector('.video-wrapper').style.display = 'flex';
      document.querySelector('.controls').style.display = 'flex';
    }

    function removePatient(button) {
      const listItem = button.closest('.appointment-item');
      if (listItem) {
        const room = listItem.getAttribute('data-room');
    
        // Confirm if call is active on that alias
        if (currentAlias && currentAlias.includes(room)) {
          alert('You must end the active video call before removing this patient.');
          return;
        }
    
        listItem.remove();
    
        // Optionally, re-enable this room in the dropdown
        const roomSelect = document.getElementById('room');
        if (roomSelect) {
          const opt = document.createElement('option');
          opt.value = room;
          opt.textContent = room;
          roomSelect.appendChild(opt);
        }
    
        console.log(`Removed patient observation for room ${room}`);
      }
    }

  </script>
  <!-- PexRTC library + your app logic -->
  <script src="https://cklab-edges.ck-collab-engtest.com/static/webrtc/js/pexrtc.js"></script>
  <script src="js/app.js"></script>
</body>
</html>
